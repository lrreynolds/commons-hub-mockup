<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Commonshub — Funding options</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body class="flow">
  <div class="wrap" style="grid-template-columns:1fr; max-width:980px;">
    <main class="stage" style="width:100%;">
      <div class="topbar">
        <div class="left">
          <div class="logoMark"></div>
          <div class="meta">
            <b>Funding</b>
            <span>Choose what to offer · change anytime</span>
          </div>
        </div>

        <a class="secondary" href="#" data-reset="all" style="width:auto;">Start over</a>
      </div>

      <div class="content">
        <div class="center" style="max-width:760px;">

          <section class="card">
            <h3 style="margin:0 0 6px;">Support link</h3>
            <div class="muted">
              This is the link you can share anywhere (Substack, YouTube, email, socials).
            </div>

            <div class="footerBar" style="margin-top:14px; gap:12px;">
              <button class="primary" id="copySupportBtn" type="button" style="flex:1; justify-content:center;">
                Copy support link
              </button>
              <a class="secondary" id="previewSupportBtn" href="#" style="flex:1; width:auto; justify-content:center;">
                Preview page
              </a>
            </div>

            <div class="field" id="supportField" style="margin-top:12px; display:none;">
              <label>Support link</label>
              <input id="supportLink" type="text" value="" readonly />
              <div class="muted" style="margin-top:6px;">
                Tip: you can also post this link as a pinned post.
              </div>
            </div>
          </section>

          <section class="card" style="margin-top:14px;">
            <h3 style="margin:0 0 6px;">What to offer</h3>
            <div class="muted">Participation is always free. Support is optional.</div>

            <!-- Subscriptions -->
            <div class="card" style="background:var(--card2); margin-top:14px;">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:14px;">
                <div>
                  <b>Subscriptions</b>
                  <div class="muted" style="margin-top:2px;">Monthly support with a small supporter badge.</div>
                </div>

                <label style="display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none;">
                  <span class="muted" style="font-size:13px;">Off</span>
                  <input id="subsToggle" type="checkbox" style="width:18px; height:18px;" />
                  <span class="muted" style="font-size:13px;">On</span>
                </label>
              </div>

              <div id="subsAmounts" style="margin-top:12px;">
                <div class="muted" style="font-size:13px; margin-bottom:8px;">Suggested amounts</div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="secondary amountChip" data-kind="subs" data-value="1" type="button" style="width:auto;" aria-pressed="true">$1 / mo</button>
                  <button class="secondary amountChip" data-kind="subs" data-value="3" type="button" style="width:auto;" aria-pressed="true">$3 / mo</button>
                  <button class="secondary amountChip" data-kind="subs" data-value="other" type="button" style="width:auto;" aria-pressed="true">Other</button>
                </div>
              </div>
            </div>

            <!-- Tips -->
            <div class="card" style="background:var(--card2); margin-top:12px;">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:14px;">
                <div>
                  <b>One-time tips</b>
                  <div class="muted" style="margin-top:2px;">A simple thank-you. No perks required.</div>
                </div>

                <label style="display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none;">
                  <span class="muted" style="font-size:13px;">Off</span>
                  <input id="tipsToggle" type="checkbox" style="width:18px; height:18px;" />
                  <span class="muted" style="font-size:13px;">On</span>
                </label>
              </div>

              <div id="tipsAmounts" style="margin-top:12px;">
                <div class="muted" style="font-size:13px; margin-bottom:8px;">Suggested amounts</div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="secondary amountChip" data-kind="tips" data-value="1" type="button" style="width:auto;" aria-pressed="true">$1</button>
                  <button class="secondary amountChip" data-kind="tips" data-value="3" type="button" style="width:auto;" aria-pressed="true">$3</button>
                  <button class="secondary amountChip" data-kind="tips" data-value="other" type="button" style="width:auto;" aria-pressed="true">Other</button>
                </div>
              </div>
            </div>

            <!-- Campaigns (later) -->
            <div class="note" style="margin-top:14px;">
              <b>Campaigns:</b> Coming later (goal-based fundraising).
            </div>

            <div class="footerBar" style="margin-top:16px;">
              <a class="secondary" href="dashboard.html" style="width:auto;">Back to dashboard</a>
              <a class="primary" id="continueBtn" href="funding-post.html">Continue</a>
            </div>
          </section>

        </div>
      </div>
    </main>
  </div>

  <script src="assets/app.js"></script>
  <script>
    (() => {
      // --- Keys (mock state) ---
      const K_STRIPE = "commonshub_stripe_connected";
      const K_SUBS_ON = "commonshub_funding_subs_on";
      const K_TIPS_ON = "commonshub_funding_tips_on";
      const K_SUBS_AMTS = "commonshub_funding_amounts_subs";
      const K_TIPS_AMTS = "commonshub_funding_amounts_tips";
      const K_SUPPORT_LINK = "commonshub_support_link";

      // A stable “magic link” for the mock. Replace later with real routing.
      const DEFAULT_SUPPORT_LINK = "https://mycommunity.commonshub.social/support";

      // Ensure stripe is connected if someone lands here directly (router should already do this)
      try {
        if (localStorage.getItem(K_STRIPE) !== "1") {
          window.location.replace("funding.html");
          return;
        }
      } catch {}

      // Defaults
      function getCsv(key, fallbackCsv) {
        try {
          const v = localStorage.getItem(key);
          if (!v) return fallbackCsv.split(",").filter(Boolean);
          return v.split(",").map(s => s.trim()).filter(Boolean);
        } catch {
          return fallbackCsv.split(",").filter(Boolean);
        }
      }
      function setCsv(key, arr) {
        try { localStorage.setItem(key, arr.join(",")); } catch {}
      }
      function getOn(key, fallbackOn) {
        try {
          const v = localStorage.getItem(key);
          if (v === null) return fallbackOn;
          return v === "1";
        } catch {
          return fallbackOn;
        }
      }
      function setOn(key, on) {
        try { localStorage.setItem(key, on ? "1" : "0"); } catch {}
      }

      // Elements
      const subsToggle = document.getElementById("subsToggle");
      const tipsToggle = document.getElementById("tipsToggle");
      const subsAmounts = document.getElementById("subsAmounts");
      const tipsAmounts = document.getElementById("tipsAmounts");
      const chips = Array.from(document.querySelectorAll(".amountChip"));

      const copyBtn = document.getElementById("copySupportBtn");
      const supportField = document.getElementById("supportField");
      const supportInput = document.getElementById("supportLink");
      const previewBtn = document.getElementById("previewSupportBtn");

      // Support link setup
      let supportLink = DEFAULT_SUPPORT_LINK;
      try {
        supportLink = localStorage.getItem(K_SUPPORT_LINK) || DEFAULT_SUPPORT_LINK;
        localStorage.setItem(K_SUPPORT_LINK, supportLink);
      } catch {}
      supportInput.value = supportLink;
      previewBtn.href = supportLink;

      async function copyText(text) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch {
          return false;
        }
      }

      copyBtn.addEventListener("click", async () => {
        supportField.style.display = "block";
        supportInput.focus();
        supportInput.select();

        const ok = await copyText(supportInput.value);
        if (!ok) {
          try { document.execCommand("copy"); } catch {}
        }

        const old = copyBtn.textContent;
        copyBtn.textContent = "Copied";
        setTimeout(() => (copyBtn.textContent = old), 900);
      });

      // Load persisted state
      const subsOn = getOn(K_SUBS_ON, true);
      const tipsOn = getOn(K_TIPS_ON, true);
      const subsSelected = new Set(getCsv(K_SUBS_AMTS, "1,3,other"));
      const tipsSelected = new Set(getCsv(K_TIPS_AMTS, "1,3,other"));

      subsToggle.checked = subsOn;
      tipsToggle.checked = tipsOn;

      function syncVisibility() {
        subsAmounts.style.display = subsToggle.checked ? "block" : "none";
        tipsAmounts.style.display = tipsToggle.checked ? "block" : "none";
        setOn(K_SUBS_ON, subsToggle.checked);
        setOn(K_TIPS_ON, tipsToggle.checked);
      }

      function syncChipsUI() {
        chips.forEach(btn => {
          const kind = btn.getAttribute("data-kind");
          const value = btn.getAttribute("data-value");

          const selected = (kind === "subs" ? subsSelected : tipsSelected).has(value);
          btn.setAttribute("aria-pressed", selected ? "true" : "false");

          // subtle selected state without new CSS
          btn.style.border = selected ? "2px solid rgba(31,111,74,.35)" : "";
          btn.style.background = selected ? "rgba(31,111,74,.06)" : "";
          btn.style.fontWeight = selected ? "800" : "";
        });

        setCsv(K_SUBS_AMTS, Array.from(subsSelected));
        setCsv(K_TIPS_AMTS, Array.from(tipsSelected));
      }

      subsToggle.addEventListener("change", () => {
        syncVisibility();
      });
      tipsToggle.addEventListener("change", () => {
        syncVisibility();
      });

      chips.forEach(btn => {
        btn.addEventListener("click", () => {
          const kind = btn.getAttribute("data-kind");
          const value = btn.getAttribute("data-value");
          const set = kind === "subs" ? subsSelected : tipsSelected;

          if (set.has(value)) set.delete(value);
          else set.add(value);

          // Guardrail: don't allow "On" with zero amounts selected (keep at least one)
          if (kind === "subs" && subsToggle.checked && subsSelected.size === 0) subsSelected.add("1");
          if (kind === "tips" && tipsToggle.checked && tipsSelected.size === 0) tipsSelected.add("1");

          syncChipsUI();
        });
      });

      // Initial render
      syncVisibility();
      syncChipsUI();

      // Start over support (since this page uses data-reset, not #resetFlowLink)
      const resetLink = document.querySelector('[data-reset="all"]');
      if (resetLink) {
        resetLink.addEventListener("click", (e) => {
          e.preventDefault();
          try {
            localStorage.removeItem("commonshub_server_live");
            localStorage.removeItem("commonshub_setup_complete");
            localStorage.removeItem("commonshub_setup_step");
            localStorage.removeItem("commonshub_celebrate_once");
            localStorage.removeItem("commonshub_stripe_connected");

            localStorage.removeItem(K_SUBS_ON);
            localStorage.removeItem(K_TIPS_ON);
            localStorage.removeItem(K_SUBS_AMTS);
            localStorage.removeItem(K_TIPS_AMTS);
            localStorage.removeItem(K_SUPPORT_LINK);
          } catch {}
          window.location.href = "index.html";
        });
      }
    })();
  </script>
</body>
</html>
